<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Competitor News ‚Äì Hybrid BBC Style</title>
<style>
:root {
  --brand: #00a99d;
  --brand-dark: #008a81;
  --bg: #fff;
  --ink: #000;
  --border: #ddd;
}

/* Reset */
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'Helvetica Neue', Arial, sans-serif;
  background: var(--bg);
  color: var(--ink);
}

/* Header */
header {
  background: linear-gradient(135deg, var(--brand) 0%, #1cc2b5 100%);
  color: #fff;
  padding: 24px;
  text-align: center;
}
header h1 {
  font-size: 28px;
  font-weight: 700;
}

/* Controls */
.controls {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 16px;
  margin-top: 16px;
}
.control select, .control input {
  width: 100%;
  padding: 12px;
  border: 1px solid var(--border);
  font-size: 14px;
}

/* Main content */
main.wrap {
  max-width: 1280px;
  margin: 0 auto;
  padding: 32px 16px;
}

/* Grid */
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 24px;
}

/* Card */
.card {
  border: 1px solid var(--border);
  box-shadow: none;
  border-radius: 0;
  display: flex;
  flex-direction: column;
  background: #fff;
}
.card img.thumb {
  width: 100%;
  height: auto;
  object-fit: cover;
}
.pad { padding: 16px; }
.title {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 8px;
}
.meta {
  font-size: 13px;
  color: #666;
  border-bottom: 1px solid #eee;
  padding-bottom: 8px;
  margin-bottom: 8px;
}
.summary {
  font-size: 14px;
  color: #444;
  margin-bottom: 12px;
}
.actions {
  display: flex;
  gap: 8px;
  padding: 0 16px 16px;
}
.link {
  flex: 1;
  text-align: center;
  text-decoration: none;
  padding: 10px 14px;
  border: 1px solid var(--border);
  font-weight: 600;
  font-size: 14px;
  color: #333;
  background: #fff;
  transition: background 0.2s ease;
}
.link:hover {
  background: var(--brand);
  color: #fff;
}
.link.primary {
  background: var(--brand);
  color: #fff;
}
.link.primary:hover {
  background: var(--brand-dark);
}

/* Responsive */
@media (max-width: 768px) {
  header h1 { font-size: 24px; }
  .title { font-size: 16px; }
}
</style>
</head>
<body>
<header>
  <h1>Competitor News</h1>
  <div class="controls">
    <div class="control"><select id="source"><option value="">All Companies</option></select></div>
    <div class="control"><select id="line"><option value="">All Product Lines</option><option value="CRP">CRP</option><option value="Bars">Bars</option><option value="Geotec">Geotec</option></select></div>
    <div class="control"><input type="text" id="search" placeholder="üîç Search keyword..." /></div>
    <div class="control">
      <select id="sort">
        <option value="date_desc">üìÖ Newest First</option>
        <option value="date_asc">üìÖ Oldest First</option>
        <option value="title_asc">üî§ Title A‚ÄìZ</option>
        <option value="title_desc">üî§ Title Z‚ÄìA</option>
      </select>
    </div>
  </div>
</header>

<main class="wrap">
  <div id="status" class="empty">Loading articles‚Ä¶</div>
  <div class="article-count" id="articleCount" hidden></div>
  <section id="grid" class="grid" hidden></section>
  <nav id="pager" class="pager" hidden>
    <button class="btn" id="prev">‚Üê Previous</button>
    <span id="pageInfo" class="muted"></span>
    <button class="btn" id="next">Next ‚Üí</button>
  </nav>
</main>

<button id="backToTop" onclick="window.scrollTo({ top: 0, behavior: 'smooth' });">‚Üë Top</button>

<script/cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js</script>
<script>
  const byId = id => document.getElementById(id);
  const el = (tag, cls) => { const e=document.createElement(tag); if(cls) e.className=cls; return e; }

  const STATE = { raw:[], filtered:[], page:1, pageSize:12, sort:'date_desc', source:'', search:'', line:'' };

  const LOGO_BASE = "https://raw.githubusercontent.com/jumpbcc158/Logos/main/";
  const LOGO_DEFAULT = LOGO_BASE + "0 Logo Dextra RGB Web Colors.png";

  const LINE_LOGOS = {
    "crp": LOGO_BASE + "CRP_16x9_white.png",
    "bars": LOGO_BASE + "Bars_16x9_white.png",
    "geotec": LOGO_BASE + "Geo_16x9_white.png"
  };

  const normalize = s => (s || "")
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/[\u2018\u2019]/g, "'")
    .replace(/[\u2013\u2014]/g, "-")
    .replace(/[^a-z0-9]+/g, " ")
    .replace(/\s+/g, " ").trim();

  /* --- Canonical logos (fixed spelling: firep minova) --- */
  const LOGO_MAP = {
    "dywidag": "DYWIDAG_16x9.png",
    "anker schroeder": "Anker_Schroeder_16x9.png",
    "ancon": "Leviat_Ancon_16x9.png",
    "stahlwerk annahutte": "SAH_Stahlwerk_Annahutte_16x9.png",
    "sah": "SAH_Stahlwerk_Annahutte_16x9.png",
    "nvent lenton": "nVent_Lenton_16x9.png",
    "lenton": "nVent_Lenton_16x9.png",
    "macalloy": "Macalloy_16x9.png",
    "moment": "Leviat_Moment_16x9.png",
    "firep minova": "FiReP_16x9.png",
    "williams form": "Williams_Form_16x9.png",
    "splice sleeve": "Splice_Sleeve_16x9.png",
    "boowon bms": "Boowon_BMS_16x9.png",
    "mateenbar": "Mateenbar_16x9.png",
    "mst bar": "MST_Bar_16x9.png"
  };

  /* --- Aliases coming from CSV (normalize to canonical) --- */
  const LOGO_ALIASES = {
    "williams": "williams form",
    "williams form engineering": "williams form",
    "williams form engineering corp": "williams form",
    "william form": "williams form",
    "moment (leviat)": "moment",
    "leviat moment": "moment",
    "moment-leviat": "moment",
    "moment leviat": "moment",
    "ancon (leviat)": "ancon",
    "minova apac": "firep minova",
    "firep": "firep minova",
    "fi rep": "firep minova",
    "fi rep minova": "firep minova",
    "mstbar": "mst bar",
    "mst-bar": "mst bar",
    "sah annahutte": "stahlwerk annahutte",
    "stahlwerk annahuette": "stahlwerk annahutte"
  };

  /* --- Product lines per canonical source --- */
  const LINE_MAP = {
    "moment": ["CRP"],
    "ancon": ["CRP"],
    "nvent lenton": ["CRP"],
    "splice sleeve": ["CRP"],
    "boowon bms": ["CRP"],
    "dywidag": ["Bars", "Geotec"],
    "anker schroeder": ["Bars"],
    "macalloy": ["Bars"],
    "williams form": ["Bars"],
    "stahlwerk annahutte": ["Bars", "Geotec"],
    "sah": ["Bars", "Geotec"],
    "mateenbar": ["Geotec"],
    "mst bar": ["Geotec"],
    "firep minova": ["Geotec"]
  };

  /* --- Display name mapping (what the user sees) --- */
  const DISPLAY_NAME = {
    "moment": "Moment",
    "ancon": "Ancon",
    "nvent lenton": "nVent LENTON",
    "firep minova": "FiReP Minova",
    "dywidag": "DYWIDAG",
    "anker schroeder": "Anker Schroeder",
    "stahlwerk annahutte": "Stahlwerk Annah√ºtte",
    "sah": "Stahlwerk Annah√ºtte",
    "macalloy": "Macalloy",
    "williams form": "Williams Form",
    "splice sleeve": "Splice Sleeve",
    "mateenbar": "Mateenbar",
    "mst bar": "MST Bar",
    "boowon bms": "Boowon BMS"
  };

  function displayFor(canon) {
    if (!canon) return '';
    if (DISPLAY_NAME[canon]) return DISPLAY_NAME[canon];
    return canon.replace(/\b\w/g, c => c.toUpperCase());
  }

  function logoFileFor(canonical) {
    if (LOGO_MAP[canonical]) return LOGO_MAP[canonical];
    let bestKey = null;
    for (const k in LOGO_MAP) {
      if (canonical.includes(k)) { if (!bestKey || k.length > bestKey.length) bestKey = k; }
    }
    return bestKey ? LOGO_MAP[bestKey] : null;
  }

  function canonicalFor(name) {
    const key = normalize(name);
    return LOGO_ALIASES[key] || key;
  }

  function logoSrcFor(nameOrCanon) {
    const canonical = canonicalFor(nameOrCanon);
    const file = logoFileFor(canonical);
    return file ? (LOGO_BASE + file) : null;
  }

  function linesFor(name) {
    const canonical = canonicalFor(name);
    return LINE_MAP[canonical] || [];
  }

  function setHeaderLogo() {
    const img = byId("brandImg");
    const companyLogo = STATE.source && logoSrcFor(STATE.source); // STATE.source is canonical
    const lineKey = (STATE.line || '').toLowerCase();
    const lineSrc = LINE_LOGOS[lineKey];
    const src = companyLogo || lineSrc || LOGO_DEFAULT;

    img.hidden = false;
    img.alt = companyLogo ? displayFor(STATE.source) : (STATE.line || 'Dextra');
    img.src = src;
    img.onerror = () => { img.onerror = null; img.src = LOGO_DEFAULT; };
  }

  function parseDate(v) {
    if (!v) return null;
    const d = new Date(v);
    if (!isNaN(d)) return d;
    const m = String(v).match(/(\d{1,2})[\/.\-](\d{1,2})[\/.\-](\d{2,4})/);
    if (m) {
      const [_, d1, m1, y1] = m;
      const yr = y1.length === 2 ? (Number(y1) + 2000) : Number(y1);
      return new Date(yr, Number(m1) - 1, Number(d1));
    }
    return null;
  }

  function loadCSV() {
    Papa.parse('export_combined.csv', {
      download: true, header: true, skipEmptyLines: true,
      complete: (res) => {
        const rows = res.data.map(r => {
          const srcRaw   = r.Source?.trim() || '';
          const srcCanon = canonicalFor(srcRaw);

          // Normalize ISO date (prefer CSV DateISO; fallback to parsed Date/DateText)
          const isoCSV = (r.DateISO || '').trim().slice(0, 10); // YYYY-MM-DD
          const fallbackObj = parseDate(r.Date || r.DateText);
          const isoFallback = fallbackObj ? fallbackObj.toISOString().slice(0,10) : '';
          const dateISO = isoCSV || isoFallback;

          // Robust numeric sort key; blank ‚Üí 0 (goes to bottom on DESC)
          const dateKeyNum = dateISO ? Number(dateISO.replace(/-/g, '')) : 0;

          return {
            Title: r.Title?.trim() || '',
            DateText: r.DateText?.trim() || '',
            DateISO: dateISO,
            DateObj: fallbackObj || null,
            DateKeyNum: dateKeyNum,
            Link: r.Link?.trim() || '',
            Image: r.Image?.trim() || '',
            Summary: r.Summary?.trim() || '',
            Source: srcRaw,                      // original
            SourceCanon: srcCanon,               // normalized key
            SourceDisplay: displayFor(srcCanon), // pretty label
            Lines: linesFor(srcRaw)
          };
        });

        STATE.raw = rows;
        hydrateSources(rows);

        const params = new URLSearchParams(location.search);
        const preCompany = params.get('company');
        const preLine = params.get('line');
        const preSearch = params.get('search');
        const preSort = params.get('sort');
        
        if (preCompany) {
          const cand = canonicalFor(preCompany);
          if ([...byId('source').options].some(o => o.value === cand)) {
            byId('source').value = cand;
            STATE.source = cand;
          }
        }
        if (preLine && ["CRP","Bars","Geotec"].includes(preLine)) {
          byId('line').value = preLine;
          STATE.line = preLine;
        }
        if (preSearch) {
          byId('search').value = preSearch;
          STATE.search = preSearch;
        }
        if (preSort && ['date_desc', 'date_asc', 'title_asc', 'title_desc'].includes(preSort)) {
          byId('sort').value = preSort;
          STATE.sort = preSort;
        }

        setHeaderLogo();
        applyFilters();
      },
      error: () => { byId('status').textContent = 'Could not load export_combined.csv.'; }
    });
  }

  /* Populate dropdown using canonical values but display nice names */
  function hydrateSources(rows) {
    const sel = byId('source');
    const uniqCanon = [...new Set(rows.map(r => r.SourceCanon).filter(Boolean))]
      .sort((a,b) => displayFor(a).localeCompare(displayFor(b)));
    uniqCanon.forEach(canon => {
      const o = el('option');
      o.value = canon;                   // filter by canonical
      o.textContent = displayFor(canon); // label users see
      sel.appendChild(o);
    });
  }

  function applyFilters() {
    const { source, sort, search, line } = STATE;
    let rows = STATE.raw.filter(r =>
      (!source || r.SourceCanon === source) &&
      (!line || (r.Lines && r.Lines.includes(line))) &&
      (!search || r.Title.toLowerCase().includes(search.toLowerCase()) || r.Summary.toLowerCase().includes(search.toLowerCase()))
    );

    rows.sort((a, b) => {
      switch (sort) {
        case 'title_asc':  return a.Title.localeCompare(b.Title);
        case 'title_desc': return b.Title.localeCompare(a.Title);
        case 'date_asc':
          return (a.DateKeyNum - b.DateKeyNum) ||
                 a.Title.localeCompare(b.Title);
        default: // date_desc
          return (b.DateKeyNum - a.DateKeyNum) ||
                 a.Title.localeCompare(b.Title);
      }
    });

    STATE.filtered = rows;
    STATE.page = 1;
    render();
  }

  function render() {
    const grid = byId('grid');
    const status = byId('status');
    const pager = byId('pager');
    const count = byId('articleCount');

    const total = STATE.filtered.length;
    if (!total) {
      grid.hidden = true; pager.hidden = true; count.hidden = true;
      status.hidden = false; status.textContent = 'No articles found.';
      return;
    }

    status.hidden = true;
    grid.hidden = false;
    pager.hidden = false;
    count.hidden = false;
    grid.innerHTML = '';

    const start = (STATE.page - 1) * STATE.pageSize;
    const end = start + STATE.pageSize;
    const rows = STATE.filtered.slice(start, end);
    rows.forEach(r => grid.appendChild(card(r)));

    const totalPages = Math.max(1, Math.ceil(total / STATE.pageSize));
    byId('pageInfo').textContent = `Page ${STATE.page} / ${totalPages}`;
    byId('prev').disabled = STATE.page <= 1;
    byId('next').disabled = STATE.page >= totalPages;

    count.textContent = `Showing ${start + 1}‚Äì${Math.min(end, total)} of ${total} articles`;
  }

  function card(row) {
    const c = el('article', 'card');
    const img = el('img', 'thumb');
    img.loading = 'lazy';
    img.alt = row.Title || 'thumbnail';
    img.src = row.Image || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22225%22><rect width=%22400%22 height=%22225%22 fill=%22%23f1f5f9%22/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%2394a3b8%22 font-size=%2218%22 font-family=%22system-ui%22 font-weight=%22600%22>No image available</text></svg>';
    img.onerror = () => {
      img.onerror = null;
      img.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="225"><rect width="400" height="225" fill="%23f1f5f9"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%2394a3b8" font-size="18" font-family="system-ui" font-weight="600">No image available</text></svg>';
    };
    c.appendChild(img);

    const p = el('div', 'pad');
    const h = el('h2', 'title'); h.textContent = row.Title || '(Untitled)';
    const meta = el('div', 'meta');

    const chip = el('span', 'chip'); 
    chip.textContent = row.SourceDisplay || 'Unknown';
    meta.append(chip);

    if (row.Lines && row.Lines.length) {
      row.Lines.forEach(L => { const ch = el('span', 'chip line'); ch.textContent = L; meta.append('‚Ä¢', ch); });
    }

    const date = el('span');
    date.textContent = row.DateISO || '';
    meta.append('‚Ä¢', date);

    const sum = el('p', 'summary'); sum.textContent = row.Summary || '';
    p.append(h, meta, sum);
    c.appendChild(p);

    const actions = el('div', 'actions');
    const a1 = el('a', 'link primary'); a1.href = row.Link || '#'; a1.target = '_blank'; a1.rel = 'noopener'; a1.textContent = 'Read Article';
    const a2 = el('a', 'link'); a2.href = `https://www.google.com/search?q=${encodeURIComponent((row.Title || '') + ' ' + (row.SourceDisplay || ''))}`; a2.target = '_blank'; a2.rel = 'noopener'; a2.textContent = 'Search More';
    actions.append(a1, a2);
    c.appendChild(actions);

    return c;
  }

  byId('source').addEventListener('change', e => { STATE.source = e.target.value; setHeaderLogo(); applyFilters(); });
  byId('line').addEventListener('change', e => { STATE.line = e.target.value; setHeaderLogo(); applyFilters(); });
  byId('sort').addEventListener('change', e => { STATE.sort = e.target.value; applyFilters(); });
  byId('search').addEventListener('input', e => { STATE.search = e.target.value; applyFilters(); });
  byId('prev').addEventListener('click', () => { STATE.page = Math.max(1, STATE.page - 1); render(); window.scrollTo({ top: 0, behavior: 'smooth' }); });
  byId('next').addEventListener('click', () => { const totalPages = Math.max(1, Math.ceil(STATE.filtered.length / STATE.pageSize)); STATE.page = Math.min(totalPages, STATE.page + 1); render(); window.scrollTo({ top: 0, behavior: 'smooth' }); });

  window.addEventListener('scroll', () => { const btn = byId('backToTop'); btn.style.display = window.scrollY > 300 ? 'block' : 'none'; });

  setHeaderLogo();
  loadCSV();
</body>
</html>
