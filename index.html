<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Competitor News</title>
  <style>
    :root {
      --bg: #f5f7fb;
      --card: #ffffff;
      --ink: #0f172a;
      --brand: #00a99d;
      --max: 1200px;
    }
    html, body { height: 100%; margin: 0; font-family: 'Segoe UI', sans-serif; color: var(--ink); background: var(--bg); scroll-behavior: smooth; }

    .wrap { max-width: var(--max); margin: 0 auto; padding: 24px }

    header { background: linear-gradient(90deg, var(--brand), #1cc2b5); color: #fff }
    header .wrap { padding: 28px 24px 24px }

    .brand-vertical { display: flex; flex-direction: column; align-items: center; gap: 18px; text-align: center }
    .logo { width: 200px; aspect-ratio: 16/9; border-radius: 14px; background: #fff; display: grid; place-items: center; overflow: hidden; box-shadow: 0 4px 14px rgba(0,0,0,.15) }
    .logo img { width: 100%; height: 100%; object-fit: contain }

    h1 { margin: 0; font-size: 30px; font-weight: 700; letter-spacing: .3px; color: #fff }

    .controls { display: flex; justify-content: center; flex-wrap: wrap; gap: 16px; margin-top: 20px }

    .control select, .control input { padding: 11px 12px; border-radius: 10px; border: 1px solid #d7dee9; background: #fff; outline: none; min-width: 220px; }
    .control select:focus, .control input:focus { border-color: var(--brand); box-shadow: 0 0 0 4px rgba(0,169,157,.35); }

    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 16px; margin-top: 24px; }

    .card { grid-column: span 4; background: var(--card); border-radius: 16px; box-shadow: 0 8px 24px rgba(15,23,42,.06); overflow: hidden; display: flex; flex-direction: column; transition: transform .1s ease, box-shadow .1s ease; animation: fadeIn .3s ease; }
    .card:hover { transform: translateY(-3px); box-shadow: 0 10px 28px rgba(15,23,42,.1) }
    .thumb { width: 100%; aspect-ratio: 16/9; background: #eef2f7; object-fit: cover }
    .pad { padding: 14px 16px }

    .title { font-weight: 700; font-size: 16px; margin: 0 0 6px }
    .summary { color: #475569; font-size: 14px; line-height: 1.45; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden }
    .meta { display: flex; gap: 8px; align-items: center; margin: 10px 0 12px; font-size: 12px; color: #64748b }
    .meta .chip { background: #e2f7f4; color: #038a81; padding: 4px 8px; border-radius: 999px }
    .meta .chip.line { background: #eef2ff; color: #334155 }

    .actions { display: flex; gap: 10px; margin-top: auto; padding: 0 16px 14px }
    .link { flex: 1; text-align: center; text-decoration: none; padding: 10px 12px; border-radius: 10px; border: 1px solid #d7dee9; background: #fff; }
    .link.primary { background: var(--brand); color: #fff; border-color: transparent }

    .empty, #status { background: #fff; border: 1px dashed #cbd5e1; padding: 20px; border-radius: 12px; text-align: center; color: #64748b; margin-top: 20px; }

    .pager, .article-count { display: flex; justify-content: center; align-items: center; margin: 24px 0; gap: 12px; }

    .btn { padding: 10px 12px; border-radius: 10px; border: 1px solid #d7dee9; background: #fff; cursor: pointer; }
    .btn:disabled { opacity: .5; cursor: not-allowed; }

    #backToTop { position: fixed; bottom: 24px; right: 24px; background: var(--brand); color: white; border: none; padding: 12px 16px; border-radius: 8px; cursor: pointer; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.15); }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    @media (max-width: 1024px) { .card { grid-column: span 6 } }
    @media (max-width: 640px)  { .card { grid-column: span 12 } }
  </style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="brand-vertical">
      <div class="logo" title="Brand"><img id="brandImg" alt="Brand"></div>
      <h1>Competitor News</h1>
    </div>
    <div class="controls">
      <div class="control"><select id="source"><option value="">All Companies</option></select></div>
      <div class="control"><select id="line"><option value="">All Product Lines</option><option value="CRP">CRP</option><option value="Bars">Bars</option><option value="Geotec">Geotec</option></select></div>
      <div class="control"><input type="text" id="search" placeholder="Search keyword..." /></div>
      <div class="control">
        <select id="sort">
          <option value="date_desc">Newest First</option>
          <option value="date_asc">Oldest First</option>
          <option value="title_asc">Title A–Z</option>
          <option value="title_desc">Title Z–A</option>
        </select>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div id="status" class="empty">Loading articles…</div>
  <div class="article-count" id="articleCount" hidden></div>
  <section id="grid" class="grid" hidden></section>
  <nav id="pager" class="pager" hidden>
    <button class="btn" id="prev">Prev</button>
    <span id="pageInfo" class="muted"></span>
    <button class="btn" id="next">Next</button>
  </nav>
</main>

<button id="backToTop" onclick="window.scrollTo({ top: 0, behavior: 'smooth' });">↑ Back to Top</button>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
  const byId = id => document.getElementById(id);
  const el = (tag, cls) => { const e=document.createElement(tag); if(cls) e.className=cls; return e; }

  const STATE = { raw:[], filtered:[], page:1, pageSize:12, sort:'date_desc', source:'', search:'', line:'' };

  const LOGO_BASE = "https://raw.githubusercontent.com/jumpbcc158/Logos/main/";
  const LOGO_DEFAULT = LOGO_BASE + "0 Logo Dextra RGB Web Colors.png";

  // Product line header logos provided by you
  const LINE_LOGOS = {
    "crp": LOGO_BASE + "CRP_16x9_white.png",
    "bars": LOGO_BASE + "Bars_16x9_white.png",
    "geotec": LOGO_BASE + "Geo_16x9_white.png"
  };

  // Strong normalize: lower-case, strip accents/punctuation, collapse whitespace
  const normalize = s => (s || "")
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // accents → plain
    .replace(/[\u2018\u2019]/g, "'")                  // curly quotes → '
    .replace(/[\u2013\u2014]/g, "-")                  // en/em dash → -
    .replace(/[^a-z0-9]+/g, " ")                        // non-alnum → space
    .replace(/\s+/g, " ").trim();

  // Canonical map: keys MUST be normalized
  const LOGO_MAP = {
    "dywidag": "DYWIDAG_16x9.png",
    "anker schroeder": "Anker_Schroeder_16x9.png",
    "leviat": "Leviat_Ancon_16x9.png",
    "ancon": "Leviat_Ancon_16x9.png",
    "sah": "SAH_Stahlwerk_Annahutte_16x9.png",
    "stahlwerk annahutte": "SAH_Stahlwerk_Annahutte_16x9.png",
    "nvent lenton": "nVent_Lenton_16x9.png",
    "lenton": "nVent_Lenton_16x9.png",
    "macalloy": "Macalloy_16x9.png",
    "moment": "Leviat_Moment_16x9.png",
    // fixed ones
    "firep minova": "FiReP_16x9.png",
    "williams form": "Williams_Form_16x9.png",
    // others that appear in your image
    "splice sleeve": "Splice_Sleeve_16x9.png",
    "boowon bms": "Boowon_BMS_16x9.png",
    "mateenbar": "Mateenbar_16x9.png",
    "mst bar": "MST_Bar_16x9.png"
  };

  // Aliases map: variant → canonical key present in LOGO_MAP
  const LOGO_ALIASES = {
    // FiReP / Minova variants
    "firep": "firep minova",
    "fi rep": "firep minova",
    "fi rep minova": "firep minova",
    "minova": "firep minova",
    "minova firep": "firep minova",

    // Williams variants
    "williams": "williams form",
    "williams form engineering": "williams form",
    "williams form engineering corp": "williams form",
    "william form": "williams form",

    // Leviat family variants
    "moment (leviat)": "moment",
    "leviat moment": "moment",
    "ancon (leviat)": "ancon",

    // MST formatting variants
    "mstbar": "mst bar",
    "mst-bar": "mst bar"
  };

  // Product line memberships (multiple allowed). Keys use canonical competitor names.
  const LINE_MAP = {
    // CRP
    "moment": ["CRP"],
    "ancon": ["CRP"],
    "leviat": ["CRP"],
    "nvent lenton": ["CRP"],
    "splice sleeve": ["CRP"],
    "boowon bms": ["CRP"],

    // Bars (Engineered Bar System)
    "dywidag": ["Bars", "Geotec"],
    "anker schroeder": ["Bars"],
    "macalloy": ["Bars"],
    "williams form": ["Bars"],
    "sah": ["Bars", "Geotec"],
    "stahlwerk annahutte": ["Bars", "Geotec"],

    // Geotec (Ground Engineering)
    "mateenbar": ["Geotec"],
    "mst bar": ["Geotec"],
    "firep minova": ["Geotec"]
  };

  function logoFileFor(canonical) {
    if (LOGO_MAP[canonical]) return LOGO_MAP[canonical];
    // Fuzzy: pick the longest key that is contained in the canonical string
    let bestKey = null;
    for (const k in LOGO_MAP) {
      if (canonical.includes(k)) { if (!bestKey || k.length > bestKey.length) bestKey = k; }
    }
    return bestKey ? LOGO_MAP[bestKey] : null;
  }

  function canonicalFor(name) {
    const key = normalize(name);
    return LOGO_ALIASES[key] || key;
  }

  function logoSrcFor(name) {
    const canonical = canonicalFor(name);
    const file = logoFileFor(canonical);
    return file ? (LOGO_BASE + file) : null;
  }

  function linesFor(name) {
    const canonical = canonicalFor(name);
    return LINE_MAP[canonical] || [];
  }

  function setHeaderLogo() {
    const img = byId("brandImg");
    // Priority: specific company > product line > default
    const company = STATE.source && logoSrcFor(STATE.source);
    const lineKey = (STATE.line || '').toLowerCase();
    const lineSrc = LINE_LOGOS[lineKey];
    const src = company || lineSrc || LOGO_DEFAULT;

    img.hidden = false;
    img.alt = company ? STATE.source : (STATE.line || 'Dextra');
    img.src = src;
    img.onerror = () => { img.onerror = null; img.src = LOGO_DEFAULT; };
  }

  function parseDate(v) {
    if (!v) return null;
    const d = new Date(v);
    if (!isNaN(d)) return d;
    const m = String(v).match(/(\d{1,2})[\/.\-](\d{1,2})[\/.\-](\d{2,4})/);
    if (m) {
      const [_, d1, m1, y1] = m;
      const yr = y1.length === 2 ? (Number(y1) + 2000) : Number(y1);
      return new Date(yr, Number(m1) - 1, Number(d1));
    }
    return null;
  }

  function loadCSV() {
    Papa.parse('export_combined.csv', {
      download: true, header: true, skipEmptyLines: true,
      complete: (res) => {
        const rows = res.data.map(r => ({
          Title: r.Title?.trim() || '',
          DateText: r.DateText?.trim() || '',
          DateObj: parseDate(r.Date || r.DateText) || null,
          Link: r.Link?.trim() || '',
          Image: r.Image?.trim() || '',
          Summary: r.Summary?.trim() || '',
          Source: r.Source?.trim() || '',
          Lines: linesFor(r.Source?.trim() || '')
        }));
        STATE.raw = rows;
        hydrateSources(rows);

        const params = new URLSearchParams(location.search);
        const preCompany = params.get('company');
        const preLine = params.get('line');
        if (preCompany && [...byId('source').options].some(o => o.value === preCompany)) {
          byId('source').value = preCompany;
          STATE.source = preCompany;
        }
        if (preLine && ["CRP","Bars","Geotec"].includes(preLine)) {
          byId('line').value = preLine;
          STATE.line = preLine;
        }

        setHeaderLogo();
        applyFilters();
      },
      error: () => { byId('status').textContent = 'Could not load export_combined.csv.'; }
    });
  }

  function hydrateSources(rows) {
    const sel = byId('source');
    const uniq = [...new Set(rows.map(r => r.Source).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
    uniq.forEach(s => { const o = el('option'); o.value = s; o.textContent = s; sel.appendChild(o); });
  }

  function applyFilters() {
    const { source, sort, search, line } = STATE;
    let rows = STATE.raw.filter(r =>
      (!source || r.Source === source) &&
      (!line || (r.Lines && r.Lines.includes(line))) &&
      (!search || r.Title.toLowerCase().includes(search.toLowerCase()) || r.Summary.toLowerCase().includes(search.toLowerCase()))
    );

    rows.sort((a, b) => {
      switch (sort) {
        case 'title_asc': return a.Title.localeCompare(b.Title);
        case 'title_desc': return b.Title.localeCompare(a.Title);
        case 'date_asc': return (a.DateObj?.getTime() || 0) - (b.DateObj?.getTime() || 0);
        default: return (b.DateObj?.getTime() || 0) - (a.DateObj?.getTime() || 0);
      }
    });

    STATE.filtered = rows;
    STATE.page = 1;
    render();
  }

  function render() {
    const grid = byId('grid');
    const status = byId('status');
    const pager = byId('pager');
    const count = byId('articleCount');

    const total = STATE.filtered.length;
    if (!total) {
      grid.hidden = true; pager.hidden = true; count.hidden = true;
      status.hidden = false; status.textContent = 'No articles found.';
      return;
    }

    status.hidden = true;
    grid.hidden = false;
    pager.hidden = false;
    count.hidden = false;
    grid.innerHTML = '';

    const start = (STATE.page - 1) * STATE.pageSize;
    const end = start + STATE.pageSize;
    const rows = STATE.filtered.slice(start, end);
    rows.forEach(r => grid.appendChild(card(r)));

    const totalPages = Math.max(1, Math.ceil(total / STATE.pageSize));
    byId('pageInfo').textContent = `Page ${STATE.page} / ${totalPages}`;
    byId('prev').disabled = STATE.page <= 1;
    byId('next').disabled = STATE.page >= totalPages;

    count.textContent = `Showing ${start + 1}–${Math.min(end, total)} of ${total} articles`;
  }

  function card(row) {
    const c = el('article', 'card');
    const img = el('img', 'thumb');
    img.loading = 'lazy';
    img.alt = row.Title || 'thumbnail';
    img.src = row.Image || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22225%22><rect width=%22400%22 height=%22225%22 fill=%22%23eef2f7%22/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%2394a3b8%22 font-size=%2220%22 font-family=%22Segoe UI%22>No image</text></svg>';
    img.onerror = () => {
      img.onerror = null;
      img.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="225"><rect width="400" height="225" fill="%23eef2f7"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%2394a3b8" font-size="20" font-family="Segoe UI">No image</text></svg>';
    };
    c.appendChild(img);

    const p = el('div', 'pad');
    const h = el('h2', 'title'); h.textContent = row.Title || '(Untitled)';
    const meta = el('div', 'meta');
    const chip = el('span', 'chip'); chip.textContent = row.Source || 'Unknown';
    meta.append(chip);

    // Add product line chips if present (supports multiple)
    if (row.Lines && row.Lines.length) {
      row.Lines.forEach(L => { const ch = el('span', 'chip line'); ch.textContent = L; meta.append('•', ch); });
    }

    const date = el('span'); date.textContent = row.DateText || (row.DateObj ? row.DateObj.toLocaleDateString() : '');
    meta.append('•', date);

    const sum = el('p', 'summary'); sum.textContent = row.Summary || '';
    p.append(h, meta, sum);
    c.appendChild(p);

    const actions = el('div', 'actions');
    const a1 = el('a', 'link primary'); a1.href = row.Link || '#'; a1.target = '_blank'; a1.rel = 'noopener'; a1.textContent = 'Open Article';
    const a2 = el('a', 'link'); a2.href = `https://www.google.com/search?q=${encodeURIComponent((row.Title || '') + ' ' + (row.Source || ''))}`; a2.target = '_blank'; a2.rel = 'noopener'; a2.textContent = 'Search';
    actions.append(a1, a2);
    c.appendChild(actions);

    return c;
  }

  byId('source').addEventListener('change', e => { STATE.source = e.target.value; setHeaderLogo(); applyFilters(); });
  byId('line').addEventListener('change', e => { STATE.line = e.target.value; setHeaderLogo(); applyFilters(); });
  byId('sort').addEventListener('change', e => { STATE.sort = e.target.value; applyFilters(); });
  byId('search').addEventListener('input', e => { STATE.search = e.target.value; applyFilters(); });
  byId('prev').addEventListener('click', () => { STATE.page = Math.max(1, STATE.page - 1); render(); });
  byId('next').addEventListener('click', () => { const totalPages = Math.max(1, Math.ceil(STATE.filtered.length / STATE.pageSize)); STATE.page = Math.min(totalPages, STATE.page + 1); render(); });

  window.addEventListener('scroll', () => { const btn = byId('backToTop'); btn.style.display = window.scrollY > 300 ? 'block' : 'none'; });

  setHeaderLogo();
  loadCSV();
</script>
</body>
</html>
